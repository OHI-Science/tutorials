<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>calculate scores using prepared data layers</title>

<script src="modify_goal_models_1_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="modify_goal_models_1_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="modify_goal_models_1_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="modify_goal_models_1_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="modify_goal_models_1_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="modify_goal_models_1_files/navigation-1.1/tabsets.js"></script>
<link href="modify_goal_models_1_files/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="modify_goal_models_1_files/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="header">



<h1 class="title toc-ignore">calculate scores using prepared data layers</h1>

</div>


<p><em>TODO JSL: some kind of overview like:</em> This chapter will take you from prepared data to calculated scores. It requires book keeping, <code>R</code> functions, and ultimately, the <code>R</code> package <code>ohicore</code>…</p>
<p>In this section, we won’t be modifying goal models yet. Instead, to get you familiar with the construct of functions.R and the sequence of events that are involved in modifying goal models, we’ll plug in the data layer that you just prepped, saved, and registered (link to previous data prep section), follow these steps to calculate scores:</p>
<ol style="list-style-type: decimal">
<li><p>Save and register data layers</p></li>
<li><p>load ohicore and check data layers <em>in <code>configure_toolbox.r</code></em></p></li>
<li>Update goal model <em>in <code>conf/functions.r</code></em></li>
</ol>
<ul>
<li>load data (<code>functions.r</code>)</li>
<li>calculate status scores (<code>functions.r</code>)</li>
<li>calculate trend scores (<code>functions.r</code>)</li>
<li>combine status and trend scores (<code>functions.r</code>)</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li><p>check and possibly update how the function is called <em>in <code>conf/goals.csv</code></em></p></li>
<li><p>calculate the remaining component of OHI scores <em>in <code>calculate_scores.r</code></em></p></li>
</ol>
<p>We will go through each of the scripts mentioned above. Here is a general structure to show where those files are in relation to the entire calcualtion process:</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1zHe1Gp2L7xN04w3NO_uQvOrl47Ug_oogyj2E338J90U/pub?w=960&amp;h=600" />

</div>
<p>Now let’s get started and give it a try!</p>
<div id="step-1-save-and-register-data-layers" class="section level2">
<h2>Step 1: Save and register data layers</h2>
<p>Before processed data can be used by the toolbox for calculations, they need to be saved and registered here:</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1IwHf8pMBlpzOIYKL0hoEF5rETGA765Qtwkz7es7B3Rg/pub?h=500" />

</div>
<div id="save-data-layers-in-the-layers-folder" class="section level3">
<h3>1.1 Save data layers in the <em>layers</em> folder</h3>
<p>When modifying existing or creating new data layers in the prep folder, save the ready-to-use layers in this folder. We recommend saving it as a new <em>.csv</em> file with:</p>
<ul>
<li>a prefix identifying the goal (eg. <code>fis_</code>)</li>
<li>a suffix identifying your assessment (eg. <code>_sc2016.csv</code>).</li>
</ul>
<p>Modifying the layer name provides an easy way to track which data layers have been updated regionally, and which rely on global data. Then, the original layers (<code>_gl2016.csv</code> and <code>_gl2016placeholder.csv</code>) can be deleted.</p>
<p><em><strong>Tip</strong>: filenames should not have any spaces: use an underscore instead. This will reduce problems when R reads the files.</em></p>
</div>
<div id="register-data-layers-in-layers.csv" class="section level3">
<h3>1.2 Register data layers in <code>layers.csv</code></h3>
<p>After you saved the data layer and named it properly, now you can register it in <code>layers.csv</code>. This will tell the Toolbox where to look for data when you calculate scores.</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1juueRiA0gevOoHH_8owzLNanyQ-H1mAOEl7L_l5YSJ0/pub?h=600" />

</div>
<p><em>If a layer simply has a new filename, only the <em>filename</em> column needs to be updated.</em></p>
</div>
</div>
<div id="step-2-source-configure_toolbox.r" class="section level2">
<h2>Step 2: Source <code>configure_toolbox.r</code></h2>
<p>Now you have fully prepared and registered the data with the Toolbox, there is just one more step before calculations! Let’s “congifure” the Toolbox:</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1CKNjIORLJOEaV2XW4Z9QuFLN7q1lJ1PaEGg2dSG1-_o/pub?h=450" />

</div>
<p>This script syncs different components of the Toolbox (eg. data layers, goal functions, etc) and makes sure that you data are ready to be called when you want to modify goal models and calculate scores.</p>
<p>More specifically, sourcing <code>configure_toolbox.r</code> will:</p>
<ol style="list-style-type: decimal">
<li>load the necessary R packages</li>
<li>load scenario configurations (eg. functions.r)</li>
<li>check that data layers are properly formatted and registered</li>
<li>load data layers so that you can call them in functions.r</li>
</ol>
<p><em><strong>Note</strong>: repeat this step whenever you save a new data layer or change a goal function.</em></p>
<p><em><strong>Tip</strong>: “Source” to run all the lines</em></p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1JvSJKyiwvp92--obTwHT3IYht1XE0823sORJ4FdnX74/pub?h=450" />

</div>
</div>
<div id="step-3-update-goal-model" class="section level2">
<h2>Step 3: Update goal model</h2>
<p>Now you are ready to modify goal models in <code>functions.r</code>. It is contained in the <code>conf</code> folder.</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1CKNjIORLJOEaV2XW4Z9QuFLN7q1lJ1PaEGg2dSG1-_o/pub?h=450" />

</div>
<p>It is pre-loaded with <code>R</code> code from the most recent OHI global assessment as a starting place. You can run through the reference script line-by-line to learn how it has been done.</p>
<p>Open <code>functions.r</code>, go to the appropriate goal function. We will use Artisanal Fishing Opportunity (AO) as an example.</p>
<p><em><strong>Tip</strong>: Clicking the bottom left corner of Console will show you a drop-down menu of all functions. It’s a shortcut to jump to the appropriate section or goal model.</em></p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1Z2AVtVfIZEd_5GDcmaLb8mRpErKTDzmcbg0SBMxKsxs/pub?h=450" />

</div>
<p><em>Each goal model is written as a function, and you will modify the goal model within the confines of each function.</em></p>
<div id="load-data" class="section level3">
<h3>3.1 Load data</h3>
<p>Run this chunk of code and the data layers will be loaded, joined, and ready to be manipulated further:</p>
<pre class="r"><code>## &quot;SelectLayersData&quot; is an ohicore funtion to call the appropriate data layer by its layer name registered in`layers.csv` (eg. &quot;ao_access&quot;)

## &quot;select&quot;&quot; is a function from the dplyr package to let you select only the columns you would need

r &lt;- SelectLayersData(layers, layers = &#39;ao_access&#39;, narrow=TRUE) %&gt;%
    select(region_id=id_num, access=val_num)
r &lt;- na.omit(r)

ry &lt;- SelectLayersData(layers, layers = &#39;ao_need&#39;, narrow=TRUE) %&gt;%
    select(region_id = id_num, year, need=val_num) %&gt;%
    left_join(r, by=&quot;region_id&quot;)</code></pre>
<blockquote>
<p>Tip: it’s always a good idea to check what your data looks like and make sure there are no glaring errors. A couple of commonly used functions are: head() and str()</p>
</blockquote>
</div>
<div id="calculate-status" class="section level3">
<h3>3.2 Calculate status</h3>
<p>Once you make sure your raw data have been loaded and joined in the right format, you can start calculate status scores!</p>
<pre class="r"><code># model: this step calculates status scores of all years, using the goal model. 

## &quot;mutate&quot; is another commonly used function from dplyr that allows you to add a new column to the data frame
## Note that &quot;Sustainability&quot; and &quot;status_year&quot; have been defined at the start of the AO function 
  Sustainability=1.0
  status_year = 2015

  ry &lt;- ry %&gt;%
    mutate(Du = (1 - need) * (1 - access)) %&gt;%
    mutate(status = (1 - Du) * Sustainability)

# status: status scores are typically the most recent year of all the years you have calculated. 

  r.status &lt;- ry %&gt;%
    filter(year==status_year) %&gt;%
    select(region_id, status) %&gt;%
    mutate(status=status*100)</code></pre>
</div>
<div id="calculate-trend" class="section level3">
<h3>3.3 Calculate trend</h3>
<p>Trend scores are typically based on linear regression of status scores from the most recent five years.</p>
<pre class="r"><code> # choose trend years (eg. most recent five years)

  trend_years &lt;- (status_year-4):(status_year)
  adj_trend_year &lt;- min(trend_years)

  r.trend = ry %&gt;%
    group_by(region_id) %&gt;% 
    # linear model: 
    do(mdl = lm(status ~ year, data=., subset=year %in% trend_years),
       adjust_trend = .$status[.$year == adj_trend_year]) %&gt;%
    # extract the coefficient of year and produce a trend score
    summarize(region_id, trend = ifelse(coef(mdl)[&#39;year&#39;]==0, 0, coef(mdl)[&#39;year&#39;]/adjust_trend * 5)) %&gt;%
    # make sure that the scores are between -1 and 1
    mutate(trend = ifelse(trend&gt;1, 1, trend)) %&gt;%
    mutate(trend = ifelse(trend&lt;(-1), (-1), trend)) %&gt;%
    mutate(trend = round(trend, 4))</code></pre>
</div>
<div id="combine-status-and-trend-scores" class="section level3">
<h3>3.4 Combine status and trend scores</h3>
<p>Choose only region_id and score, and add two more columns identifying score dimension (status or trend) and goal name.</p>
<pre class="r"><code> scores = r.status %&gt;%
    select(region_id, score=status) %&gt;%
    mutate(dimension=&#39;status&#39;) %&gt;%
    rbind(
      r.trend %&gt;%
        select(region_id, score=trend) %&gt;%
        mutate(dimension=&#39;trend&#39;)) %&gt;%
    mutate(goal=&#39;AO&#39;)</code></pre>
</div>
</div>
<div id="step-4.-update-goal-call-in-goals.csv" class="section level2">
<h2>Step 4. Update goal call in <code>goals.csv</code>**</h2>
<p><code>goals.csv</code> in the <code>conf</code> folder provides input information for <code>functions.r</code>, particularly about function calls. These are indicated by two columns: <em>preindex_function</em> (functions for all goals that do not have sub-goals, and functions for all sub-goals) and <em>postindex_function</em> (functions for goals with sub-goals).</p>
<p>In the <code>preindex_fuction</code>, you could specify variables such as <em>status_year</em> and <em>trend_year</em>, which you can call in your goal function. Note that it is not necessary to specify those variables. If you do not use them in your function as in the CS example, you could delete those variables in <code>preindex_function</code>.</p>
<p><em>Changing goal weights will be done here by editing the value in the <em>weight</em> column. Weights do not need to be 0-1 or add up to 10; weights will be scaled as a proportion of the number of goals assessed. The ten goals are weighted equally by default.</em></p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/17BgYSw2sHbZvHNjUqBlTG-kCOAAn7o6a65O37s0S_es/pub?h=500" />

</div>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1o2wtJ9KCPDyGPH9Y4unmALG6BlxX9lmJ_PakDDiQrLo/pub?h=500" />

</div>
</div>
<div id="step-5.-calculate-overall-scores" class="section level2">
<h2>Step 5. Calculate overall scores</h2>
<p>Hooray you’ve modified a goal function! Now let’s calculate the remaining score components (pressures, resilience, likely future state, and overall score). This is done in <code>calculate_scores.r</code></p>
<p><em>We’ll learn how to modify Pressures and Resilience matrix in a different chapter.</em></p>
<pre class="r"><code># calculate scenario scores
scores = CalculateAll(conf, layers, debug=F)

# save scores as .csv file, tables and figures
write.csv(scores, &#39;scores.csv&#39;, na=&#39;&#39;, row.names=F)</code></pre>
<p>After the calculation is done, you should be able to see the compiled score sheet for all goals in all regions in sub-country/scores.csv.</p>
<p>It is very likely that during the CalculateAll process you’ll encounter problems and see error messages. In most cases, the error messages can specify what the error is and in which step it occurs, which should be helpful for trouble shooting. Some commonly occurring errors and how to fix them can be found in the Troubleshooting section of the manual.</p>
<p><em><strong>Tip</strong>: whenever there are changes made (addition, deletion, changes in .csv or r script), you would be notified in the Git window. So here, since you added a new data layer and/more modified a function, and are expecting changes in score.csv, you should see it in Git. This is a good place to double check whether you have made the right changes.</em></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
